<nz-card [nzTitle]="costTitleTpl" [nzExtra]="paymentTaxTpl" *ngIf="treatypayInfo">

    <ng-template #costTitleTpl>
      <span>发票台账</span>
    </ng-template>
    <ng-template #paymentTaxTpl>
      <button nz-button [nzType]="'primary'"
        (click)="addPaymentCost(tplTitle, tplContent, tplFooter, $event)">新增台账</button>
    </ng-template>
      <nz-table #costSelectTable [nzData]="listOfData" [nzFrontPagination]="false">
        <thead>
          <tr>
            <th>支付单序号</th>
            <th>费用类别</th>
            <th nzWidth="300px">出票单位</th>
            <th>发票类型</th>
            <th>发票金额（不含税）</th>
            <th>税额</th>
            <th>价税合计</th>
            <th *ngIf="treatypayInfo.draft">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of costSelectTable.data">
            <td>{{ data.index }}</td>
            <td>{{ data.contract_payment.treaty.service_category.name }}</td>
            <td>{{ data.company.name }}</td>
            <td>
              <ng-container *ngIf="data.bill_category">
                {{ data.bill_category.name }}
              </ng-container>
              <ng-container *ngIf="!data.bill_category">
                暂未取得发票
              </ng-container>
            </td>
            <td>
              <ng-container *ngIf="data.bill_category">
                {{ data.exclude_tax_amount | _currency }}
              </ng-container>
            </td>
            <td>
              <ng-container *ngIf="data.bill_category">
                {{ data.tax_amount | _currency }}
              </ng-container>
            </td>
            <td>
              <ng-container *ngIf="data.bill_category">
                {{ data.exclude_tax_amount + data.tax_amount | _currency }}
              </ng-container>
              <ng-container *ngIf="!data.bill_category">
                {{ data.amount | _currency }}
              </ng-container>
            </td>
            
            <td *ngIf="!treatypayInfo || treatypayInfo.draft">
              <a (click)="edit(tplTitle, tplContent, tplFooter, data)"><i nz-icon nzType="edit"
                  nzTheme="outline"></i></a>
              <nz-divider nzType="vertical"></nz-divider>
              <a nz-popconfirm nzPopconfirmTitle="确认删除当前非合同支付详情对应台账?" (nzOnConfirm)="disabledPayment(data.id)"
                (nzOnCancel)="cancel()" class="text-error">删除</a>
            </td>
          </tr>
        </tbody>
      </nz-table>

  </nz-card>

  
<!-- 成本支付新增 modal -->

<ng-template #tplTitle>
    <span>非合约支付台账</span>
  </ng-template>
  <ng-template #tplContent>
    <div class="modal-form">
      <form nz-form [formGroup]="validateForm">
  
        <nz-form-item>
          <nz-form-label nzFor="treaty_payment_id" nzRequired>协议支付</nz-form-label>
          <nz-form-control nzErrorTip="请选择非合约支付详情">
            <nz-select style="width: 100%;" id="treaty_payment_id" nzShowSearch nzPlaceHolder="请选择非合约支付详情"
              formControlName="treaty_payment_id" (ngModelChange)="treatyPaymentChange($event)">
              <ng-container *ngFor="let item of paymentArray">
                <nz-option [nzLabel]="item.abstract" [nzValue]="item.id"></nz-option>
              </ng-container>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzFor="is_get_bill" nzRequired>是否开票</nz-form-label>
          <nz-form-control nzErrorTip="请选择是否已经开具发票" (ngModelChange)="isGetBillChange($event)">
            <nz-radio-group id="is_get_bill" formControlName="is_get_bill">
              <label nz-radio [nzValue]="true">已开票</label>
              <label nz-radio [nzValue]="false">未开票</label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>

        <ng-container *ngIf="validateForm.get('is_get_bill').value && currentPayment">
          <nz-form-item>
            <nz-form-label nzFor="bill_category_id" nzRequired>发票类型</nz-form-label>
            <nz-form-control nzErrorTip="请选择发票类型">
              <nz-select style="width: 100%;" id="bill_category_id" nzPlaceHolder="请选择发票类型"
                formControlName="bill_category_id">
                <ng-container *ngFor="let item of billCategoryArray">
                  <nz-option [nzLabel]="item.name" [nzValue]="item.id"
                  [nzDisabled]="checkedOption[currentPayment?.cost.cost_category.id + '-' + currentPayment?.treaty.supplier.id + '-' + item.id]"></nz-option>
                    
                </ng-container>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label nzFor="exclude_tax_amount" nzRequired>除税金额</nz-form-label>
            <nz-form-control nzErrorTip="请填写支付金额中除税金额{{ currentPayment ? '，不得超过' + currentPayment.amount + '元' : '' }}">
              <nz-input-group nzSuffix="RMB" nzPrefix="￥" style="width: 100%;">
                  <input type="text" nz-input (ngModelChange)="amountChange()" placeholder="请填写支付金额中除税金额{{ currentPayment ? '，不得超过' + currentPayment.amount + '元' : '' }}" formControlName="exclude_tax_amount" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label nzFor="tax_amount" nzRequired>税金</nz-form-label>
            <nz-form-control nzErrorTip="请填写支付金额中含税金额">
              <nz-input-group nzSuffix="RMB" nzPrefix="￥" style="width: 100%;">
                  <input type="text" nz-input (ngModelChange)="amountChange()" placeholder="请填写支付金额中含税金额" formControlName="tax_amount" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </ng-container>
        <ng-container *ngIf="!validateForm.get('is_get_bill').value && currentPayment">
          <nz-form-item>
            <nz-form-label nzFor="amount" nzRequired>支付总金额</nz-form-label>
            <nz-form-control nzErrorTip="请填写非合约支付总金额{{ currentPayment ? '，不得超过' + currentPayment.amount + '元' : '' }}">
              <nz-input-group nzSuffix="RMB" nzPrefix="￥" style="width: 100%;">
                  <input type="text" nz-input (ngModelChange)="amountChange()" placeholder="非合约支付总金额{{ currentPayment ? '，不得超过' + currentPayment.amount + '元' : '' }}" formControlName="amount" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </ng-container>

        <nz-form-item>
          <nz-form-label nzFor="index" nzRequired>序号</nz-form-label>
          <nz-form-control nzErrorTip="请填写序号">
            <input type="text" id="index" formControlName="index" placeHolder="填写序号" nz-input />
          </nz-form-control>
        </nz-form-item>
        <ng-container *ngIf="validateForm.get('is_get_bill').value && totalAmountError && currentPayment">
          <div class="text-center text-error">除税金额和税金总和不得超过 {{ currentPayment.amount }} 元</div>
        </ng-container>
        <ng-container *ngIf="!validateForm.get('is_get_bill').value && totalAmountError && currentPayment">
          <div class="text-center text-error">支付总金额不得超过 {{ currentPayment.amount }} 元</div>
        </ng-container>
      </form>
    </div>
  </ng-template>
  <ng-template #tplFooter>
    <button nz-button nzType="default" (click)="closeModal()">取消</button>
    <button nz-button nzType="primary" (click)="submitTaxForm()" [nzLoading]="submitCostLoading">确定</button>
  </ng-template>

