<page-header [title]="pageTitle" [breadcrumb]="breadcrumb" [action]="actionBtn">

  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item><a [routerLink]="['/dashboard']">首页</a></nz-breadcrumb-item>
      <nz-breadcrumb-item>非合约支付管理</nz-breadcrumb-item>
      <nz-breadcrumb-item>非合约支付申请</nz-breadcrumb-item>
      <nz-breadcrumb-item><a [routerLink]="['/approve/no-contract/list']">项目列表</a></nz-breadcrumb-item>
      <nz-breadcrumb-item><a [routerLink]="['/approve/no-contract/list/apply/pay', projectId]">项目非合约支付管理</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>{{ pageTitle }}</nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>

  <ng-template #actionBtn>
    <button nz-button (click)="printCurrentModal('print-box',  projectInfo?.name)">打印</button>
    <button nz-button nz-dropdown [nzDropdownMenu]="opMenu" class="mx-sm">
      下载 <i nz-icon nzType="download" nzTheme="outline"></i>
    </button>
    <nz-dropdown-menu #opMenu="nzDropdownMenu">
      <ul nz-menu>
        <li nz-menu-item (click)="downloadFile('pdf')"><i nz-icon nzType="file-pdf" nzTheme="outline"></i> .pdf</li>
        <li nz-menu-item (click)="downloadFile('image')"><i nz-icon nzType="file-excel" nzTheme="outline"></i> .image
        </li>
      </ul>
    </nz-dropdown-menu>
    <!-- <ng-container *ngIf="listOfData.length !== 0 "> -->
    <!-- <button *ngIf="!treatypayInfo || treatypayInfo.draft" nz-button [nzType]="'dashed'" (click)="submitTreatyForm()"
      [nzLoading]="saveLoading">保存</button> -->

    <ng-container
      *ngIf="treaty_pay_id  &&  treatypayInfo?.amount === (treatypayInfo?.write_off_amount ? treatypayInfo?.tax_use_amount - treatypayInfo?.write_off_amount : treatypayInfo?.tax_use_amount) && treatypayInfo?.amount!==0">
      <a *ngIf="!treatypayInfo || treatypayInfo.draft" nz-popconfirm nz-button [nzType]="'primary'" class="mx-sm"
        nzPopconfirmTitle="请确认非合约支付信息填写完整，无误后继续提交！！！" (nzOnConfirm)="submitContractPay()" (nzOnCancel)="cancel()">
        提交
      </a>
    </ng-container>

    <!-- </ng-container> -->

  </ng-template>


  <app-project-info-show-tpl [projectInfo]="projectInfo"></app-project-info-show-tpl>

</page-header>

<div id="print-box">
  <nz-card nzTitle="非合约支付资料">
    <form nz-form [formGroup]="validateTreatyForm">

      <div nz-row [nzGutter]="24">
        <div nz-col [nzMd]="12" [nzSm]="24">
          <nz-form-item>
            <nz-form-label nzFor="pay_company" nzRequired>收款单位(个人)</nz-form-label>
            <nz-form-control nzErrorTip="请填写收款单位（个人）名称">
              <input type="text" id="pay_company" formControlName="pay_company" placeHolder="收款单位（个人）名称" nz-input />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzMd]="12" [nzSm]="24">
          <nz-form-item>
            <nz-form-label nzFor="if_write_off" nzRequired>是否冲销借款</nz-form-label>
            <nz-form-control nzErrorTip="请选择是否冲销个人借款">
              <nz-radio-group id="if_write_off" formControlName="if_write_off">
                <label nz-radio [nzValue]="true">是</label>
                <label nz-radio [nzValue]="false">否</label>
              </nz-radio-group>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzMd]="12" [nzSm]="24">
          <nz-form-item>
            <nz-form-label nzFor="bank_name" nzRequired>银行名称</nz-form-label>
            <nz-form-control nzErrorTip="请填写收款银行名称">
              <input type="text" id="bank_name" formControlName="bank_name" placeHolder="请填写收款银行名称" nz-input />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzMd]="12" [nzSm]="24">
          <nz-form-item>
            <nz-form-label nzFor="write_off_amount" [nzRequired]="ifWriteOff">冲抵金额</nz-form-label>
            <nz-form-control nzErrorTip="请填写冲销个人借款金额">
              <nz-input-group nzSuffix="元" nzPrefix="￥" style="width: 100%">
                <input type="text" id="write_off_amount" nzPlaceHolder="请填写冲销个人借款金额" (keydown)="disableInput()"
                  formControlName="write_off_amount" nz-input />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzMd]="12" [nzSm]="24">
          <nz-form-item>
            <nz-form-label nzFor="bank_account" nzRequired>银行账号</nz-form-label>
            <nz-form-control nzErrorTip="请填写收款人或单位银行账号">
              <input type="text" id="bank_account" formControlName="bank_account" placeHolder="请填写收款银行账号" nz-input />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzSm]="24">
          <nz-form-item>
            <nz-form-label style="line-height: 40px;">附件资料</nz-form-label>
            <nz-form-control>

              <ng-container *ngIf="treatypayInfo && !treatypayInfo.draft">
                <app-upload-file-attachment-show-c [attachmentUrl]="'/api/attachment/treaty_pay/' + treatypayInfo.id">
                </app-upload-file-attachment-show-c>
              </ng-container>

              <ng-container *ngIf="!treatypayInfo || treatypayInfo.draft">
                <app-upload-file-attachment-tpl [Attachment]="attachment" [AttachmentCategory]="attachmentCategory"
                  [isAttachmentChange]="isAttachmentChange" (attachmentChange)="attachmentChange($event)">
                </app-upload-file-attachment-tpl>
              </ng-container>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSm]="24">
          <nz-form-item>
            <nz-form-label style="line-height: 40px;">开票总金额</nz-form-label>
            <ng-container>
              <span class="mr-md">{{ contractTaxTotal || 0 | _currency }}</span>
            </ng-container>
          </nz-form-item>
        </div>
        <div nz-col [nzSm]="24" class="text-right">
          <button *ngIf="!treatypayInfo || treatypayInfo.draft" nz-button [nzType]="'primary'"
            (click)="saveTreatyForm()" [nzLoading]="saveLoading">保存非合约支付</button>
        </div>

      </div>
    </form>

  </nz-card>

  <nz-card [nzTitle]="costTitleTpl" [nzExtra]="costTpl" class="mt-md" *ngIf="treaty_pay_id">

    <ng-template #costTitleTpl>
      <span>非合约成本支付</span>
    </ng-template>
    <ng-template #costTpl>
      <button nz-button [nzType]="'primary'" *ngIf="!treatypayInfo || treatypayInfo.draft"
        (click)="addPaymentCost(tplTitle, tplContent, tplFooter, $event)">新增成本支付</button>
    </ng-template>
    <div class="hidden-mobile">
      <nz-table #costSelectTable [nzData]="listOfData" [nzFrontPagination]="false">
        <thead>
          <tr>
            <th nzWidth="80px">序号</th>
            <th>摘要</th>
            <th nzWidth="300px">服务单位</th>
            <th>本期支付（元）</th>
            <th>开票金额</th>
            <th>
              <span>类型支付总计</span>
              <span nz-tooltip [nzTooltipTitle]="'当前成本已经使用非合约支付的总金额'" class="text-md ml-sm">
                <i nz-icon nzType="exclamation-circle" nzTheme="outline"></i>
              </span>
            </th>
            <th nzWidth="320px">成本类型</th>
            <th>描述</th>
            <th *ngIf="!treatypayInfo || treatypayInfo.draft">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of costSelectTable.data; let i = index">
            <td>{{ i + 1}}</td>
            <td>{{ data.abstract }}</td>
            <td>
              <sv-container size="small" col="1">
                <sv label="单位名称"><span>{{ data.treaty.supplier.name }}</span></sv>
                <sv label="预算金额"><span>{{ data.treaty.amount | currency: 'CNY' }}</span></sv>
              </sv-container>
            </td>
            <td>{{ data.amount | currency: 'CNY' }}</td>
            <td>{{ data.tax_use_amount | currency: 'CNY' }}</td>
            <td>
              {{ treatyCostTotal(data.treaty_cost) | _currency }}
            </td>
            <td>
              <sv-container size="small" col="1">
                <sv label="类型名称">
                  <span>{{ data.cost.cost_category.name }}</span>
                  <span nz-tooltip [nzTooltipTitle]="data.cost.cost_category.description" class="text-md ml-sm">
                    <i nz-icon nzType="exclamation-circle" nzTheme="outline"></i>
                  </span>
                </sv>
                <sv label="预算总金额"><span>{{ data.cost.amount | currency: 'CNY' }}</span></sv>
                <sv label="已使用金额"><span>{{ data.cost.pay_amount | currency: 'CNY' }}</span></sv>
                <sv label="剩余使用"><span>{{ (data.cost.amount - data.cost.pay_amount) | currency: 'CNY' }}</span></sv>
              </sv-container>

            </td>
            <td>
              <span [innerHTML]="data.remark | showTextareaContent"></span>
            </td>
            <td *ngIf="!treatypayInfo || treatypayInfo.draft">
              <a (click)="edit(tplTitle, tplContent, tplFooter, data)"><i nz-icon nzType="edit"
                  nzTheme="outline"></i></a>
              <nz-divider nzType="vertical"></nz-divider>
              <a nz-popconfirm nzPopconfirmTitle="确认删除当前成本支付?" (nzOnConfirm)="disabledPayment(data.id)"
                (nzOnCancel)="cancel()" class="text-error">删除</a>
            </td>
          </tr>
        </tbody>
      </nz-table>

    </div>
    <div class="hidden-pc">
      <ng-container *ngFor="let data of listOfData">
        <nz-card [nzActions]=" (!treatypayInfo || treatypayInfo.draft) ? [actionEdit, actionDelete] : [] "
          class="mt-md">
          <nz-skeleton [nzActive]="true" [nzLoading]="false">
            <nz-card-meta [nzTitle]="treatyTitltTpl"></nz-card-meta>
            <ng-template #treatyTitltTpl>
              <span>{{ data.abstract }}</span>
            </ng-template>
            <div class="pt-md">
              <sv-container size="small">
                <sv label="费用类型">{{ data.cost.cost_category.name }}</sv>
                <sv label="预算金额支付"><span>{{ data.cost.amount | currency: 'CNY' }}</span></sv>
                <sv label="累计支付"><span>{{ data.cost.pay_amount | currency: 'CNY' }}</span></sv>
                <sv label="剩余支付"><span>{{ (data.cost.amount - data.cost.pay_amount) | currency: 'CNY' }}</span></sv>

                <sv label="本期支付"><span class="font-weight-bold">{{ data.amount | currency: 'CNY' }}</span>
                </sv>
              </sv-container>
            </div>
          </nz-skeleton>

          <ng-template #actionEdit>
            <a (click)="edit(tplTitle, tplContent, tplFooter, data)"><i nz-icon nzType="edit" nzTheme="outline"></i></a>
          </ng-template>
          <ng-template #actionDelete>
            <a nz-popconfirm nzPopconfirmTitle="确认删除当前成本支付?" (nzOnConfirm)="disabledPayment(data.id)"
              (nzOnCancel)="cancel()" class="text-error">删除</a>
          </ng-template>
        </nz-card>
      </ng-container>
    </div>
  </nz-card>

  <!-- <div class="mt-md" *ngIf="listOfData.length !== 0 && treatypayInfo"> -->
  <div class="mt-md" *ngIf="listOfData.length !== 0">
    <app-payment-tax-manage [is_execute_user]="true" [payType]="'treaty'" [payInfo]="treatypayInfo"
      [paymentArray]="listOfData" [billCategoryArray]="billCategoryArray" (outer)="readOuter()">
    </app-payment-tax-manage>
  </div>

</div>

<!-- 流程进展  新增 或者编辑时  不需要显示流程信息 -->
<nz-card [nzBordered]="false" class="mt-md" [nzTitle]="workflowStatusTitle"
  *ngIf="treatypayInfo && !treatypayInfo.draft">
  <ng-template #workflowStatusTitle>
    <span>审批进展</span>
    <span class="text-primary ml-md text-sm">{{ progressInfo?.workflow_status.name }}</span>
  </ng-template>
  <ng-container *ngIf="nodeProcess.length !== 0;else nodeProcessLoadingTpl">
    <nz-steps nzDirection="vertical" nzProgressDot class="hidden-pc">
      <nz-step [nzTitle]="'非合约支付申请'" [nzStatus]="'finish'" [nzDescription]="startDes">
        <ng-template #startDes>
          <div class="my-sm">
            {{ projectInfo?.user.name }}
          </div>
          <div>
            {{ projectInfo?.submit_time }}
          </div>
        </ng-template>
      </nz-step>
      <ng-container *ngFor="let process of nodeProcess">
        <nz-step [nzTitle]="process.node.name"
          [nzStatus]=" process.current ? 'process' : ( !process.finished ? 'wait' : ( !process.agree ?  'error' : 'finish') )"
          [nzDescription]="createDesc">
          <ng-template #createDesc>
            <div class="desc">
              <div class="my-sm">
                {{ process.user.name }}
              </div>
              <div *ngIf="process.finished; else notFinished">
                {{ process.finished_time }}
              </div>
              <span class="text-sm text-primary"
                [class.text-error]="process.finished && !process.agree">{{ process.remark }}</span>
              <ng-template #notFinished>
              </ng-template>
            </div>
          </ng-template>
        </nz-step>
      </ng-container>

      <nz-step [nzTitle]="'完成'"
        [nzStatus]=" !progressInfo.finished ? 'wait' : ( progressInfo.agree ? 'finish' : 'error' ) "></nz-step>
    </nz-steps>
    <nz-steps nzProgressDot class="hidden-mobile">
      <nz-step [nzTitle]="'非合约支付申请'" [nzStatus]="'finish'" [nzDescription]="startDes">
        <ng-template #startDes>
          <div class="my-sm">
            {{ projectInfo?.user.name }}
          </div>
          <div>
            {{ projectInfo?.submit_time }}
          </div>
        </ng-template>
      </nz-step>
      <ng-container *ngFor="let process of nodeProcess">
        <nz-step [nzTitle]="process.node.name"
          [nzStatus]=" process.current ? 'process' : ( !process.finished ? 'wait' : ( !process.agree ?  'error' : 'finish') )"
          [nzDescription]="createDesc">
          <ng-template #createDesc>
            <div class="desc">
              <div class="my-sm">
                {{ process.user.name }}
              </div>
              <div *ngIf="process.finished; else notFinished">
                {{ process.finished_time }}
              </div>
              <span class="text-sm text-primary"
                [class.text-error]="process.finished && !process.agree">{{ process.remark }}</span>
              <ng-template #notFinished>
              </ng-template>
            </div>
          </ng-template>
        </nz-step>
      </ng-container>

      <nz-step [nzTitle]="'完成'"
        [nzStatus]=" !progressInfo.finished ? 'wait' : ( progressInfo.agree ? 'finish' : 'error' ) "
        [nzDescription]="'合约支付审批完成'"></nz-step>
    </nz-steps>

  </ng-container>
  <ng-template #nodeProcessLoadingTpl>
    <div class="p-xl text-center text-lg text-primary">
      <nz-spin></nz-spin>
    </div>
  </ng-template>

</nz-card>

<!-- 流程进展 -->

<!-- 成本支付新增 modal -->

<ng-template #tplTitle>
  <span>添加非合约支付账单</span>
</ng-template>
<ng-template #tplContent>
  <div class="modal-form">
    <form nz-form [formGroup]="validateCostForm">

      <nz-form-item>
        <nz-form-label nzFor="abstract" nzRequired>摘要</nz-form-label>
        <nz-form-control nzErrorTip="请填写摘要信息">
          <input type="text" id="abstract" formControlName="abstract" placeHolder="填写成本摘要信息" nz-input />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="treaty_id" nzRequired>供应商</nz-form-label>
        <nz-form-control nzErrorTip="请选择供应商">
          <nz-select style="width: 100%;" id="treaty_id" nzShowSearch [nzDisabled]="isEditCost" nzPlaceHolder="请选择供应商"
            formControlName="treaty_id">
            <ng-container *ngFor="let item of treatyListArr">
              <nz-option [nzLabel]="item.supplier.name" [nzValue]="item.id"></nz-option>
            </ng-container>
          </nz-select>
        </nz-form-control>
      </nz-form-item>


      <nz-form-item>
        <nz-form-label nzFor="cost_id" nzRequired>成本类型</nz-form-label>
        <nz-form-control nzErrorTip="请选择成本类型">
          <nz-select style="width: 100%;" id="cost_id" nzShowSearch [nzDisabled]="isEditCost" nzPlaceHolder="请选择成本类型"
            formControlName="cost_id">
            <ng-container *ngFor="let item of costArr">
              <nz-option [nzLabel]="item.name" [nzValue]="item.id" [nzDisabled]="item.disabled"></nz-option>
            </ng-container>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label nzFor="amount" nzRequired>支付金额</nz-form-label>
        <nz-form-control [nzErrorTip]="errorAmountTpl">
          <nz-input-group nzSuffix="元" nzPrefix="￥" style="width: 100%">
            <input type="text" id="amount"
              [placeholder]="'填写成本支付金额' +  (max_pay_amount !== 0 ? '，不得超过' + max_pay_amount + '元' : '') "
              formControlName="amount" nz-input />
          </nz-input-group>
          <ng-template #errorAmountTpl let-control>
            <ng-container *ngIf="control.hasError('required')">
              请填写支付成本金额，只需填写数字
            </ng-container>
            <ng-container *ngIf="control.hasError('confirm')">
              当前成本支付金额不能超过 {{ max_pay_amount }} 元
            </ng-container>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="remark">支付备注</nz-form-label>
        <nz-form-control>
          <textarea nz-input id="remark" placeholder="填写成本支付备注信息，如无则不填" formControlName="remark"
            [nzAutosize]="{ minRows: 2, maxRows: 6 }"></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</ng-template>
<ng-template #tplFooter>
  <button nz-button nzType="default" (click)="closeModal()">取消</button>
  <button nz-button nzType="primary" (click)="handleOk()" [nzLoading]="submitCostLoading">确定</button>
</ng-template>